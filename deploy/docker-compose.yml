# Turbo-Stack Docker Compose 配置
# 整合自 RuoYi-Vue-Plus，适配 Monorepo 结构
#
# 使用方式:
#   开发环境: docker compose --profile dev up -d
#   生产环境: docker compose --profile prod up -d
#   仅基础设施: docker compose up -d (默认只启动 mysql, redis, minio)

services:
  # ==================== 基础设施 (默认启动) ====================

  mysql:
    image: mysql:8.0.42
    container_name: turbo-mysql
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ry-vue
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/conf:/etc/mysql/conf.d
      - ./mysql/init:/docker-entrypoint-initdb.d
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - turbo-network

  redis:
    image: redis:7.2.8
    container_name: turbo-redis
    ports:
      - "6379:6379"
    environment:
      TZ: Asia/Shanghai
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf
    command: redis-server /etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - turbo-network

  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: turbo-minio
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    environment:
      TZ: Asia/Shanghai
      MINIO_ROOT_USER: ruoyi
      MINIO_ROOT_PASSWORD: ruoyi123
      MINIO_COMPRESS: "off"
    volumes:
      - minio-data:/data
      - minio-config:/root/.minio
    command: server --address ':9000' --console-address ':9001' /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - turbo-network


  # ==================== 生产环境服务 (profile: prod) ====================

  nginx:
    image: nginx:1.25-alpine
    container_name: turbo-nginx
    profiles: ["prod"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/cert:/etc/nginx/cert:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - nginx-logs:/var/log/nginx
    environment:
      TZ: Asia/Shanghai
    depends_on:
      - backend-1
    restart: unless-stopped
    networks:
      - turbo-network

  backend-1:
    image: ruoyi/ruoyi-server:5.5.2
    container_name: turbo-backend-1
    profiles: ["prod"]
    environment:
      TZ: Asia/Shanghai
      SERVER_PORT: 8080
      SNAIL_PORT: 28080
      # 数据库配置 (可通过环境变量覆盖)
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ry-vue?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    volumes:
      - backend-logs-1:/ruoyi/server/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - turbo-network

  backend-2:
    image: ruoyi/ruoyi-server:5.5.2
    container_name: turbo-backend-2
    profiles: ["prod"]
    environment:
      TZ: Asia/Shanghai
      SERVER_PORT: 8081
      SNAIL_PORT: 28081
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/ry-vue?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    volumes:
      - backend-logs-2:/ruoyi/server/logs
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - turbo-network

  # ==================== 监控服务 (profile: prod) ====================

  monitor-admin:
    image: ruoyi/ruoyi-monitor-admin:5.5.2
    container_name: turbo-monitor-admin
    profiles: ["prod"]
    ports:
      - "9090:9090"
    environment:
      TZ: Asia/Shanghai
    volumes:
      - monitor-logs:/ruoyi/monitor/logs
    restart: unless-stopped
    networks:
      - turbo-network

  snailjob-server:
    image: ruoyi/ruoyi-snailjob-server:5.5.2
    container_name: turbo-snailjob-server
    profiles: ["prod"]
    ports:
      - "8800:8800"
      - "17888:17888"
    environment:
      TZ: Asia/Shanghai
    volumes:
      - snailjob-logs:/ruoyi/snailjob/logs
    depends_on:
      mysql:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - turbo-network

# ==================== 网络 ====================

networks:
  turbo-network:
    driver: bridge

# ==================== 数据卷 ====================

volumes:
  mysql-data:
  redis-data:
  minio-data:
  minio-config:
  nginx-logs:
  backend-logs-1:
  backend-logs-2:
  monitor-logs:
  snailjob-logs:
